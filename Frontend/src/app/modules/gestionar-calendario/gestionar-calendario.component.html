<app-layout [logoutLink]="'/login'">
  <!-- Fondo tipo dashboard -->
  <section
    class="min-h-[calc(100vh-32px)] px-4 py-6 md:px-8 md:py-8
           bg-slate-50
           dark:bg-gradient-to-b dark:from-slate-950 dark:via-slate-950 dark:to-slate-900"
  >
    <!-- CONTENEDOR PRINCIPAL -->
    <div
      class="h-full w-full overflow-hidden rounded-3xl
             border border-slate-200 bg-white text-slate-900
             shadow-[0_24px_60px_rgba(15,23,42,0.08)]
             dark:border-slate-800 dark:bg-slate-950/80 dark:text-slate-100
             dark:shadow-[0_24px_60px_rgba(15,23,42,0.8)] dark:backdrop-blur-sm"
    >
      <!-- HEADER -->
      <header
        class="flex flex-col gap-3 border-b border-slate-200 px-6 py-4
               md:flex-row md:items-center md:justify-between md:px-10
               bg-white
               dark:border-slate-800 dark:bg-slate-950/80"
      >
        <div>
          <h1 class="text-2xl md:text-3xl font-semibold leading-tight">
            Gestión de eventos de horario
          </h1>
          <p class="mt-1 text-xs md:text-sm text-slate-500 dark:text-slate-400">
            {{ weekLabel() }} · {{ weekIsoLabel() }}
          </p>
          <p class="mt-1 text-[11px] md:text-xs text-slate-500 dark:text-slate-400">
            Haz clic en una celda para agregar, editar o eliminar un evento global de la semana.
          </p>
        </div>

        <div class="flex flex-col items-start gap-3 md:items-end">
          <!-- Leyenda -->
          <div
            class="flex flex-wrap items-center gap-4 text-[11px] md:text-xs text-slate-500 dark:text-slate-400"
          >
            <div class="flex items-center gap-1">
              <span
                class="inline-flex h-3 w-3 rounded-full bg-slate-200 border border-slate-300
                       dark:bg-slate-900 dark:border-slate-700"
              ></span>
              <span>Sin evento</span>
            </div>
            <div class="flex items-center gap-1">
              <span
                class="inline-flex h-3 w-3 rounded-full bg-red-50 border border-red-300
                       dark:bg-red-500/20 dark:border-red-500/60"
              ></span>
              <span>Evento global</span>
            </div>
          </div>

          <!-- BOTÓN GUARDAR -->
          <button
            type="button"
            (click)="guardarSemana()"
            class="inline-flex items-center justify-center rounded-xl bg-yellow-400 px-4 py-2 text-sm md:text-base font-semibold text-[#0D1440] shadow-md shadow-yellow-400/30 transition hover:bg-yellow-300 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-slate-900"
          >
            Guardar cambios de la semana
          </button>
        </div>
      </header>

      <!-- ALERTA SIMPLE -->
      <div
        *ngIf="alertMessage"
        class="mx-6 mt-3 rounded-xl px-4 py-2 text-sm font-medium
               border
              "
        [ngClass]="{
          'bg-emerald-50 text-emerald-800 border-emerald-200 dark:bg-emerald-500/10 dark:text-emerald-200 dark:border-emerald-500/40':
            alertType === 'success',
          'bg-red-50 text-red-800 border-red-200 dark:bg-red-500/10 dark:text-red-200 dark:border-red-500/40':
            alertType === 'danger',
          'bg-amber-50 text-amber-900 border-amber-200 dark:bg-amber-500/10 dark:text-amber-100 dark:border-amber-500/40':
            alertType === 'warning'
        }"
      >
        {{ alertMessage }}
      </div>

      <!-- TABLA DE EVENTOS (VISUAL TIPO HORARIO) -->
      <div class="px-4 pb-6 pt-4 md:px-6 md:pb-8">
        <div class="overflow-x-auto">
          <div
            class="grid w-full text-xs md:text-sm"
            [ngStyle]="{ 'grid-template-columns': '160px repeat(5, minmax(0,1fr))' }"
          >
            <!-- Encabezado: columna Bloque -->
            <div
              class="bg-slate-100 border border-slate-200 px-3 py-3 text-center font-semibold uppercase tracking-wide text-[11px] text-slate-700
                     dark:bg-slate-950 dark:border-slate-800 dark:text-slate-300"
            >
              BLOQUE
            </div>

            <!-- Encabezados: días -->
            <div
              *ngFor="let d of days"
              class="bg-slate-100 border border-slate-200 px-3 py-3 text-center font-semibold uppercase tracking-wide text-[11px] text-slate-700
                     dark:bg-slate-950 dark:border-slate-800 dark:text-slate-300"
            >
              {{ d.label }}
            </div>

            <!-- Filas por bloque -->
            <ng-container *ngFor="let b of blocks; let bi = index">
              <!-- Columna izquierda: info bloque -->
              <div
                class="border border-slate-200 px-3 py-3 text-center
                       dark:border-slate-800"
                [ngClass]="{
                  'bg-slate-50 font-semibold text-slate-900 dark:bg-slate-900/80 dark:text-slate-100': !b.isLunch,
                  'bg-amber-50 text-amber-700 font-semibold dark:bg-slate-900 dark:text-amber-200': b.isLunch
                }"
              >
                <ng-container *ngIf="!b.isLunch; else almuerzoLabel">
                  <div class="text-[12px] md:text-sm leading-tight">
                    {{ b.label }}
                  </div>
                  <div
                    class="mt-0.5 text-[11px] text-slate-500 dark:text-slate-400"
                  >
                    {{ b.code }}
                  </div>
                </ng-container>

                <ng-template #almuerzoLabel>
                  <div class="text-xs md:text-sm tracking-wide">
                    Almuerzo
                  </div>
                </ng-template>
              </div>

              <!-- Celdas de bloques (no almuerzo) -->
              <ng-container *ngIf="!b.isLunch; else lunchRow">
                <div
                  *ngFor="let d of days"
                  class="border border-slate-200 bg-white hover:bg-slate-50 transition-colors cursor-pointer
                         dark:border-slate-800 dark:bg-slate-950/70 dark:hover:bg-slate-900/80"
                  (click)="openModal(d.key, bi)"
                  title="Editar evento global"
                >
                  <div
                    class="relative h-20 md:h-24 flex flex-col items-center justify-center text-center px-2"
                    [ngClass]="getCellClasses(d.key, visibleIndexToDataIndex(bi))"
                  >
                    <ng-container
                      *ngIf="hasEvent(d.key, visibleIndexToDataIndex(bi)); else emptyCell"
                    >
                      <div
                        class="text-[11px] md:text-sm font-semibold text-slate-900 dark:text-slate-50 leading-tight truncate"
                      >
                        {{ getEventTitle(d.key, visibleIndexToDataIndex(bi)) }}
                      </div>
                      <div
                        *ngIf="getEventNote(d.key, visibleIndexToDataIndex(bi))"
                        class="mt-0.5 text-[10px] md:text-[11px] text-slate-500 dark:text-slate-300 line-clamp-2"
                      >
                        {{ getEventNote(d.key, visibleIndexToDataIndex(bi)) }}
                      </div>
                    </ng-container>

                    <ng-template #emptyCell>
                      <div
                        class="text-[11px] text-slate-400 dark:text-slate-500"
                      >
                        Sin evento
                      </div>
                    </ng-template>
                  </div>
                </div>
              </ng-container>

              <!-- Fila almuerzo (col-span 5) -->
              <ng-template #lunchRow>
                <div
                  class="col-span-5 border border-slate-200 dark:border-slate-800"
                >
                  <div
                    class="h-10 md:h-12 bg-slate-100 text-slate-500 flex items-center justify-center text-[11px] md:text-xs tracking-wide uppercase
                           dark:bg-slate-900/80 dark:text-slate-400"
                  >
                    Pausa de almuerzo
                  </div>
                </div>
              </ng-template>
            </ng-container>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL EDICIÓN EVENTO GLOBAL -->
    <div
      *ngIf="modal.open"
      class="fixed inset-0 z-50 flex items-center justify-center"
    >
      <div
        class="absolute inset-0 bg-black/40 backdrop-blur-sm"
        (click)="closeModal()"
      ></div>

      <div
        class="relative w-[92%] max-w-md rounded-2xl
               border border-slate-200 bg-white text-slate-900 shadow-2xl
               dark:border-slate-800 dark:bg-slate-950/95 dark:text-slate-100"
      >
        <div
          class="px-5 py-4 border-b border-slate-200 flex items-center justify-between bg-slate-50 rounded-t-2xl
                 dark:border-slate-800 dark:bg-slate-900/80"
        >
          <div>
            <div
              class="text-[11px] uppercase tracking-wide text-slate-500 dark:text-slate-400"
            >
              Evento global
            </div>
            <div class="mt-0.5 text-sm md:text-base font-semibold">
              {{ modal.dayLabel }} — {{ modal.blockLabel }}
            </div>
          </div>
          <button
            class="p-2 rounded-full hover:bg-slate-100 text-slate-500 hover:text-slate-900 transition
                   dark:hover:bg-slate-800 dark:text-slate-400 dark:hover:text-slate-100"
            (click)="closeModal()"
            aria-label="Cerrar"
          >
            ✕
          </button>
        </div>

        <form (ngSubmit)="saveFromModal()" class="px-5 py-4 space-y-3">
          <div>
            <label
              class="text-[11px] font-medium text-slate-700 dark:text-slate-300"
              >Título del evento *</label
            >
            <input
              type="text"
              class="mt-1 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 placeholder-slate-400
                     focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500
                     dark:border-slate-700 dark:bg-slate-950 dark:text-slate-100 dark:placeholder-slate-500"
              placeholder="Ej.: Suspensión de clases, reunión general, etc."
              [(ngModel)]="modal.model.title"
              name="title"
              required
              autofocus
            />
          </div>

          <div>
            <label
              class="text-[11px] font-medium text-slate-700 dark:text-slate-300"
              >Nota (opcional)</label
            >
            <input
              type="text"
              class="mt-1 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 placeholder-slate-400
                     focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500
                     dark:border-slate-700 dark:bg-slate-950 dark:text-slate-100 dark:placeholder-slate-500"
              placeholder="Observaciones…"
              [(ngModel)]="modal.model.note"
              name="note"
            />
          </div>

          <div class="flex items-center gap-2 pt-2">
            <button
              type="submit"
              class="inline-flex items-center justify-center rounded-xl bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-md shadow-indigo-500/30 hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-slate-950"
            >
              Guardar
            </button>

            <button
              type="button"
              class="px-4 py-2 rounded-xl border border-slate-300 bg-white text-sm text-slate-700 hover:bg-slate-50
                     dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800"
              (click)="closeModal()"
            >
              Cancelar
            </button>

            <button
              type="button"
              class="ml-auto px-4 py-2 rounded-xl border border-red-200 bg-red-50 text-sm text-red-700 hover:bg-red-100
                     dark:border-red-500/40 dark:bg-red-500/10 dark:text-red-300 dark:hover:bg-red-500/20"
              (click)="clearFromModal()"
            >
              Limpiar evento
            </button>
          </div>
        </form>
      </div>
    </div>
  </section>
</app-layout>
