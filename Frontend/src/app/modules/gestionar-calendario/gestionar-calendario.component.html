<app-layout [logoutLink]="'/login'">
  <!-- Fondo tipo dashboard -->
  <section
    class="min-h-[calc(100vh-32px)] px-4 py-6 md:px-8 md:py-8
           bg-slate-50
           dark:bg-gradient-to-b dark:from-slate-950 dark:via-slate-950 dark:to-slate-900"
  >
    <div
      class="h-full w-full overflow-hidden rounded-3xl
             border border-slate-200 bg-white text-slate-900
             shadow-[0_24px_60px_rgba(15,23,42,0.08)]
             dark:border-slate-800 dark:bg-slate-950/80 dark:text-slate-100
             dark:shadow-[0_24px_60px_rgba(15,23,42,0.8)] dark:backdrop-blur-sm"
    >
      <!-- CABECERA -->
      <header
        class="px-6 py-4 md:px-10 md:py-5 border-b border-slate-200
               flex flex-col gap-3 md:flex-row md:items-center md:justify-between
               bg-white
               dark:border-slate-800 dark:bg-gradient-to-r dark:from-slate-950 dark:via-slate-900 dark:to-slate-950"
      >
        <div>
          <h1 class="text-2xl md:text-3xl font-semibold leading-tight">
            Gestión de eventos de horario
          </h1>
          <p class="mt-1 text-xl md:text-2xl text-slate-500 dark:text-slate-400">
            {{ weekLabel() }} · {{ weekIsoLabel() }}
          </p>
        </div>

        <!-- BOTÓN PRINCIPAL (amarillo institucional) -->
        <button
          type="button"
          (click)="guardarSemana()"
          class="inline-flex items-center justify-center rounded-xl bg-yellow-400 px-4 py-2 text-xl md:text-2xl font-semibold text-[#0D1440] shadow-md shadow-yellow-400/30 transition hover:bg-yellow-300 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-slate-900"
        >
          Guardar cambios
        </button>
      </header>

      <!-- CONTENIDO -->
      <div class="px-6 py-5 md:px-10 md:py-6">
        <div class="space-y-4">
          <div
            *ngFor="let d of days"
            class="rounded-2xl border border-slate-200 bg-slate-50 px-4 py-4 md:px-5 md:py-4 flex flex-col gap-4 md:flex-row md:items-start md:justify-between
                   dark:border-slate-800 dark:bg-slate-900/60 "
          >
            <!-- Columna izquierda: día -->
            <div class="w-full md:w-48">
              <div
                class="inline-flex items-center gap-3 rounded-2xl border border-slate-200 bg-white px-4 py-3 shadow-sm
                       dark:border-slate-700 dark:bg-slate-950/80"
              >
                <div
                  class="flex h-12 w-16 items-center justify-center rounded-full bg-indigo-100 text-3xl font-semibold text-indigo-700
                         dark:bg-indigo-500/20 dark:text-indigo-300"
                >
                  {{ d.label | slice:0:1 }}
                </div>
                <div class="flex flex-col">
                  <span class="text-xl font-semibold text-slate-900 dark:text-slate-50">
                    {{ d.label }}
                  </span>
                  <span class="text-xl text-slate-500 dark:text-slate-400">
                    Eventos transversales
                  </span>
                </div>
              </div>
            </div>

            <!-- Columna central: eventos del día -->
            <div class="flex-1 min-w-0">
              <ng-container *ngIf="eventsByDay[d.key]?.length; else noEvents">
                <div class="flex flex-wrap gap-3 md:gap-4">
                  <div
                    *ngFor="let ev of eventsByDay[d.key]"
                    class="max-w-sm rounded-2xl border border-slate-200 bg-white px-4 py-3 text-xs md:text-sm flex flex-col gap-1 shadow-sm
                           dark:border-slate-700 dark:bg-slate-950/80"
                  >
                    <div
                      class="font-semibold text-slate-900 dark:text-slate-50 leading-tight truncate"
                    >
                      {{ ev.title }}
                    </div>

                    <div class="text-[11px] md:text-xs text-slate-500 dark:text-slate-400">
                      Bloque:
                      <span class="font-medium text-slate-800 dark:text-slate-200">
                        {{ blocks[ev.blockIndex].label }}
                      </span>
                      <span class="text-slate-400 dark:text-slate-500">
                        {{ blocks[ev.blockIndex].code }}
                      </span>
                    </div>

                    <div
                      *ngIf="ev.note"
                      class="text-[11px] md:text-xs text-slate-500 dark:text-slate-400 truncate"
                    >
                      {{ ev.note }}
                    </div>
                  </div>
                </div>
              </ng-container>

              <ng-template #noEvents>
                <p class="text-xl md:text-xl text-slate-500 dark:text-slate-500">
                  Sin eventos para este día.
                </p>
              </ng-template>
            </div>

            <!-- Columna derecha: botón agregar -->
            <div
              class="w-full md:w-auto flex md:items-center md:justify-end pt-1 md:pt-0"
            >
              <button
                type="button"
                (click)="openModal(d.key)"
                [disabled]="!hasFreeBlocks(d.key)"
                class="inline-flex items-center justify-center gap-2 rounded-xl border border-slate-300 bg-white px-3 py-2 text-xs md:text-2xl font-semibold text-slate-700 shadow-sm transition hover:bg-slate-50 hover:border-slate-400 disabled:opacity-40 disabled:cursor-not-allowed
                       dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100 dark:hover:bg-slate-800 dark:hover:border-slate-500"
              >
                <span class="text-base leading-none">+</span>
                <span>Agregar evento</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL -->
    <div *ngIf="modal.open" class="fixed inset-0 z-50">
      <!-- Backdrop -->
      <div class="absolute inset-0 bg-black/40" (click)="closeModal()"></div>

      <!-- Diálogo -->
      <div class="absolute inset-0 flex items-center justify-center p-4">
        <div
          class="w-full max-w-4xl rounded-2xl
                 border border-slate-200 bg-white text-slate-900 shadow-2xl
                 dark:border-slate-800 dark:bg-slate-950/95 dark:text-slate-100 dark:backdrop-blur-md"
        >
          <!-- Header modal -->
          <div
            class="px-6 py-3 border-b border-slate-200 flex items-center justify-between bg-slate-50 rounded-t-2xl
                   dark:border-slate-800 dark:bg-slate-900/80"
          >
            <div>
              <div class="text-[11px] text-slate-500 dark:text-slate-400">
                Nuevo evento
              </div>
              <div class="text-sm font-semibold text-slate-900 dark:text-slate-50 leading-tight">
                {{ modal.dayLabel }}
              </div>
            </div>
            <button
              class="p-2 rounded-full hover:bg-slate-100 text-slate-500 hover:text-slate-900 transition
                     dark:hover:bg-slate-800 dark:text-slate-300 dark:hover:text-slate-100"
              (click)="closeModal()"
              aria-label="Cerrar"
            >
              ✕
            </button>
          </div>

          <!-- Form modal -->
          <form (ngSubmit)="saveFromModal()" class="px-6 py-4 space-y-3">
            <div>
              <label class="text-xs text-slate-700 dark:text-slate-300 mb-1 block">
                Título *
              </label>
              <input
                type="text"
                class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 placeholder-slate-400
                       focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500
                       dark:border-slate-700 dark:bg-slate-900/80 dark:text-slate-100 dark:placeholder-slate-500"
                placeholder="Ej.: Cambio de actividades, reunión con decano"
                [(ngModel)]="modal.model.title"
                name="title"
                required
                autofocus
              />
            </div>

            <div>
              <label class="text-xs text-slate-700 dark:text-slate-300 mb-1 block">
                Bloque *
              </label>
              <select
                class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900
                       focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500
                       dark:border-slate-700 dark:bg-slate-900/80 dark:text-slate-100"
                [(ngModel)]="modal.model.blockIndex"
                name="blockIndex"
                required
              >
                <option [ngValue]="null" disabled>
                  Selecciona un bloque…
                </option>
                <option
                  *ngFor="let i of modal.availableBlocks"
                  [ngValue]="i"
                >
                  {{ blocks[i].label }} {{ blocks[i].code }}
                </option>
              </select>
              <p class="mt-1 text-[11px] text-slate-500 dark:text-slate-500">
                Sólo se muestran bloques libres para este día.
              </p>
            </div>

            <div>
              <label class="text-xs text-slate-700 dark:text-slate-300 mb-1 block">
                Nota (opcional)
              </label>
              <input
                type="text"
                class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 placeholder-slate-400
                       focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500
                       dark:border-slate-700 dark:bg-slate-900/80 dark:text-slate-100 dark:placeholder-slate-500"
                placeholder="Observaciones…"
                [(ngModel)]="modal.model.note"
                name="note"
              />
            </div>

            <div class="flex items-center gap-2 pt-2">
              <!-- Botón principal modal (azul) -->
              <button
                type="submit"
                class="inline-flex items-center justify-center px-4 py-2 rounded-xl bg-indigo-600 text-white text-sm font-semibold shadow-md shadow-indigo-500/30 hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-slate-950"
              >
                Guardar
              </button>
              <button
                type="button"
                class="px-4 py-2 rounded-xl border border-slate-300 bg-white text-sm text-slate-700 hover:bg-slate-50
                       dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100 dark:hover:bg-slate-800"
                (click)="closeModal()"
              >
                Cancelar
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </section>
</app-layout>
