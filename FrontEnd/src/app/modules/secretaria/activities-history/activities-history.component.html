<app-layout [navItems]="secretariaNavItems" logoutLink="/login">
  <section class="max-w-7xl mx-auto px-6 py-8">
    <!-- Título + selector de vista -->
    <div class="mb-6 flex flex-wrap items-center justify-between gap-4">
      <div>
        <h1 class="text-3xl font-bold text-[#0D1440]">Historial de actividades</h1>
        <p class="text-sm text-gray-600 mt-1">
          Cambia la vista para revisar por <b>Funcionario → Mes</b> o <b>por Fecha</b>.
        </p>
      </div>

      <div class="flex items-center gap-2">
        <label class="text-sm text-gray-700">Vista:</label>
        <select
          class="border border-gray-300 rounded-md px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-yellow-400"
          [(ngModel)]="mode"
        >
          <option value="funcionarioMes">Funcionario → Mes</option>
          <option value="fecha">Por fecha (general)</option>
        </select>
      </div>
    </div>

    <!-- Estados -->
    <div *ngIf="loading" class="text-gray-500 text-sm">Cargando…</div>
    <div *ngIf="!loading && error" class="text-red-600 text-sm">{{ error }}</div>

    <!-- ========================== -->
    <!-- Vista: FUNCIONARIO -> MES -->
    <!-- ========================== -->
    <div *ngIf="!loading && !error && mode === 'funcionarioMes'" class="space-y-6">
      <div
        *ngFor="let g of grouped"
        class="bg-white rounded-xl border border-gray-200 shadow-sm"
      >
        <!-- Cabecera Funcionario -->
        <div class="px-5 py-4 border-b border-gray-200 flex items-center justify-between">
          <div class="min-w-0">
            <div class="text-lg font-bold text-[#0D1440]">{{ g.fullName }}</div>
            <div class="text-sm text-gray-600">{{ g.role }}</div>
          </div>
        </div>

        <!-- Meses -->
        <div class="p-5 space-y-5">
          <div *ngFor="let m of g.months" class="border rounded-lg border-blue-100">
            <div class="px-4 py-2 bg-[#EAF2FF] text-[#0D1440] font-semibold rounded-t-lg">
              {{ m.label }}
            </div>

            <!-- Tabla simple por mes -->
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead>
                  <tr class="text-left text-gray-700">
                    <th class="px-4 py-2 font-semibold">Fecha</th>
                    <th class="px-4 py-2 font-semibold">Actividad</th>
                    <th class="px-4 py-2 font-semibold">Detalle</th>
                    <th class="px-4 py-2 font-semibold">Estado</th>
                    <th class="px-4 py-2 font-semibold text-right">Horas</th>
                  </tr>
                </thead>
                <tbody>
                  <tr
                    *ngFor="let a of m.items"
                    class="border-t hover:bg-blue-50 transition"
                  >
                    <td class="px-4 py-2 text-gray-700">
                      {{ a.fecha | date:'dd/MM/yyyy' }}
                    </td>
                    <td class="px-4 py-2 text-gray-800 font-semibold">
                      {{ a.titulo }}
                    </td>
                    <td class="px-4 py-2 text-gray-700">{{ a.detalle }}</td>
                    <td class="px-4 py-2">
                      <span class="px-2 py-1 rounded-full text-xs font-semibold" [ngClass]="statusPillClass(a.estado)">
                        {{ a.estado }}
                      </span>
                    </td>
                    <td class="px-4 py-2 text-right text-gray-800">{{ a.horas }}</td>
                  </tr>
                </tbody>
              </table>

              <div *ngIf="m.items.length === 0" class="p-4 text-center text-gray-500">
                Sin actividades este mes.
              </div>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="grouped.length === 0" class="p-6 text-center text-gray-500 bg-white rounded-xl border">
        No hay actividades registradas.
      </div>
    </div>

    <!-- =================== -->
    <!-- Vista: POR FECHA   -->
    <!-- (historial “antiguo” con scroll si >5) -->
    <!-- =================== -->
    <div *ngIf="!loading && !error && mode === 'fecha'"
         class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-x-auto">
      <!-- contenedor con scroll condicional -->
      <div [ngClass]="{ 'max-h-96 overflow-y-auto': totalRows > 5 }">
        <table class="min-w-full text-sm">
          <thead class="bg-[#EAF2FF] text-[#0D1440]">
            <tr class="text-left">
              <th class="px-4 py-3 font-semibold">Funcionario</th>
              <th class="px-4 py-3 font-semibold">Rol</th>
              <th class="px-4 py-3 font-semibold">Fecha</th>
              <th class="px-4 py-3 font-semibold">Actividad</th>
              <th class="px-4 py-3 font-semibold">Detalle</th>
              <th class="px-4 py-3 font-semibold">Estado</th>
              <th class="px-4 py-3 font-semibold text-right">Horas</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let a of combined" class="border-t hover:bg-blue-50 transition">
              <td class="px-4 py-2 font-medium text-gray-900">{{ a.fullName }}</td>
              <td class="px-4 py-2 text-gray-700">{{ a.role }}</td>
              <td class="px-4 py-2 text-gray-700">{{ a.fecha | date:'dd/MM/yyyy' }}</td>
              <td class="px-4 py-2 text-gray-800 font-semibold">{{ a.titulo }}</td>
              <td class="px-4 py-2 text-gray-700">{{ a.detalle }}</td>
              <td class="px-4 py-2">
                <span class="px-2 py-1 rounded-full text-xs font-semibold" [ngClass]="statusPillClass(a.estado)">
                  {{ a.estado }}
                </span>
              </td>
              <td class="px-4 py-2 text-right text-gray-800">{{ a.horas }}</td>
            </tr>
          </tbody>
        </table>

        <div *ngIf="combined.length === 0" class="p-6 text-center text-gray-500">
          No hay actividades registradas.
        </div>
      </div>
    </div>
  </section>
</app-layout>
