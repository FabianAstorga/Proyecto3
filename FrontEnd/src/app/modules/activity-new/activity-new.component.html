<app-layout [title]="'Académico'" [logoutLink]="'/login'">

  <div class="min-h-screen" style="background-color:#F4F8FF;">
    <section class="max-w-6xl mx-auto px-6 py-10">
      <div class="bg-white rounded-2xl border border-blue-300 shadow-sm">
        <div class="px-8 pt-8">
          <div class="flex items-baseline justify-center gap-3">
            <img src="/logodim.png" alt="Logo" class="h-12 w-auto select-none" />
            <h2 class="text-2xl md:text-3xl font-bold text-[#0D1440] leading-tight">
              Registrar Actividad Curricular
            </h2>
          </div>
        </div>

        <!-- Aviso MULTI-DÍA inválido -->
        <div *ngIf="multi.invalid && multi.touched"
             class="mx-8 mt-4 rounded-md bg-red-50 border border-red-200 text-red-700 px-4 py-3 text-sm">
          Revisa el bloque <strong>Múltiples días</strong>: debes mantenerte dentro del mes actual y respetar feriados.
        </div>

        <form class="px-8 py-8 space-y-7" [formGroup]="form" (ngSubmit)="submit()">
          <!-- Fila 1 -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Fecha principal (ahora sin restricciones) -->
            <div class="md:col-span-1">
              <label class="block text-sm font-medium text-gray-700">Fecha (principal)</label>
              <mat-form-field appearance="outline" class="w-full mt-1">
                <input
                  matInput
                  [matDatepicker]="picker1"
                  formControlName="fecha"
                  [matDatepickerFilter]="dateFilterMain"
                  placeholder="dd/mm/aaaa"
                />
                <mat-datepicker #picker1></mat-datepicker>
                <mat-datepicker-toggle matSuffix [for]="picker1"></mat-datepicker-toggle>
              </mat-form-field>
            </div>

            <!-- Tipo de actividad -->
            <div>
              <label class="block text-sm font-medium text-gray-700">Tipo de Actividad</label>
              <mat-form-field appearance="outline" class="w-full mt-1">
                <mat-select formControlName="tipo_actividad">
                  <mat-option *ngFor="let t of tiposActividad" [value]="t">{{ t }}</mat-option>
                </mat-select>
              </mat-form-field>

              <!-- Campo “Otro (especificar)” -->
              <div *ngIf="form.get('tipo_actividad')?.value === 'Otro (especificar)'">
                <mat-form-field appearance="outline" class="w-full mt-2">
                  <input matInput formControlName="tipo_actividad_otro" placeholder="Especifica el tipo de actividad" />
                </mat-form-field>
                <p *ngIf="form.get('tipo_actividad_otro')?.touched && form.get('tipo_actividad_otro')?.invalid"
                   class="mt-1 text-xs text-red-600">
                  Campo requerido (máx. 100 caracteres).
                </p>
              </div>
            </div>

            <!-- Estado -->
            <div>
              <label class="block text-sm font-medium text-gray-700">Estado</label>
              <mat-form-field appearance="outline" class="w-full mt-1">
                <mat-select formControlName="estado">
                  <mat-option *ngFor="let e of estados" [value]="e">{{ e }}</mat-option>
                </mat-select>
              </mat-form-field>
            </div>
          </div>

          <!-- Descripción -->
          <div>
            <label class="block text-sm font-medium text-gray-700">Descripción</label>
            <mat-form-field appearance="outline" class="w-full mt-1">
              <textarea matInput rows="6" formControlName="descripcionAct"
                        placeholder="Describe brevemente la actividad realizada..."></textarea>
            </mat-form-field>
            <p *ngIf="f.descripcionAct.touched && f.descripcionAct.invalid" class="mt-1 text-sm text-red-600">
              La descripción es obligatoria (máx. 500 caracteres).
            </p>
          </div>

          <!-- MULTI-DÍA (se mantiene restricción al mes + bloqueo feriados) -->
          <div class="rounded-xl border border-gray-200 bg-gray-50 p-5" formGroupName="multi">
            <div class="flex items-center justify-between gap-4">
              <div class="text-sm font-semibold text-gray-800">Aplicar a múltiples días</div>
              <label class="inline-flex items-center gap-2 text-sm">
                <input type="checkbox" formControlName="enable"
                       class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                Habilitar
              </label>
            </div>

            <div *ngIf="multi.get('enable')?.value" class="mt-4 space-y-5">
              <!-- Selector de modo -->
              <div class="flex flex-wrap items-center gap-3 text-sm">
                <span class="text-gray-700 font-medium">Modo:</span>
                <label class="inline-flex items-center gap-2">
                  <input type="radio" value="specific" formControlName="mode"> Fechas específicas
                </label>
                <label class="inline-flex items-center gap-2">
                  <input type="radio" value="weekly" formControlName="mode"> Repetir semanalmente
                </label>
              </div>

              <!-- Fechas específicas -->
              <div *ngIf="multi.get('mode')?.value === 'specific'" class="space-y-3">
                <div class="flex flex-wrap items-center gap-3">
                  <button type="button" (click)="addSpecificDate()"
                          class="inline-flex items-center px-3 py-1.5 rounded-md border border-blue-600 text-blue-600 font-medium hover:bg-blue-50">
                    + Agregar fecha
                  </button>
                  <span class="text-xs text-gray-600">Solo dentro del mes actual (se excluyen feriados).</span>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-3" formArrayName="specificDates">
                  <div *ngFor="let _ of specificDates.controls; let i = index" class="flex items-center gap-2">
                    <mat-form-field appearance="outline" class="w-full">
                      <input
                        matInput
                        [matDatepicker]="specPicker"
                        [formControlName]="i"
                        [matDatepickerFilter]="dateFilterMulti"
                        placeholder="dd/mm/aaaa"
                      />
                      <mat-datepicker #specPicker [dateClass]="dateClass"></mat-datepicker>
                      <mat-datepicker-toggle matSuffix [for]="specPicker"></mat-datepicker-toggle>
                    </mat-form-field>
                    <button type="button" (click)="removeSpecificDate(i)" aria-label="Eliminar fecha"
                            class="px-2 py-1 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-100">✕</button>
                  </div>
                </div>
              </div>

              <!-- Repetir semanalmente -->
              <div *ngIf="multi.get('mode')?.value === 'weekly'" class="space-y-4" formGroupName="weekly">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700">Desde</label>
                    <mat-form-field appearance="outline" class="w-full mt-1">
                      <input
                        matInput
                        [matDatepicker]="startPicker"
                        formControlName="start"
                        [matDatepickerFilter]="dateFilterMulti"
                        placeholder="dd/mm/aaaa"
                      />
                      <mat-datepicker #startPicker [dateClass]="dateClass"></mat-datepicker>
                      <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
                    </mat-form-field>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700">Hasta</label>
                    <mat-form-field appearance="outline" class="w-full mt-1">
                      <input
                        matInput
                        [matDatepicker]="endPicker"
                        formControlName="end"
                        [matDatepickerFilter]="dateFilterMulti"
                        placeholder="dd/mm/aaaa"
                      />
                      <mat-datepicker #endPicker [dateClass]="dateClass"></mat-datepicker>
                      <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
                    </mat-form-field>
                    <p *ngIf="weekly.get('end')?.errors?.['range']" class="mt-1 text-xs text-red-600">
                      “Hasta” no puede ser menor que “Desde”.
                    </p>
                  </div>
                </div>

                <div formGroupName="weekdays">
                  <div class="text-sm font-medium text-gray-700 mb-2">Días de la semana</div>
                  <div class="grid grid-cols-7 gap-2 text-sm">
                    <label class="flex items-center justify-center gap-2 border rounded-md py-2 hover:bg-gray-50">
                      <input type="checkbox" formControlName="mon"> Lun
                    </label>
                    <label class="flex items-center justify-center gap-2 border rounded-md py-2 hover:bg-gray-50">
                      <input type="checkbox" formControlName="tue"> Mar
                    </label>
                    <label class="flex items-center justify-center gap-2 border rounded-md py-2 hover:bg-gray-50">
                      <input type="checkbox" formControlName="wed"> Mié
                    </label>
                    <label class="flex items-center justify-center gap-2 border rounded-md py-2 hover:bg-gray-50">
                      <input type="checkbox" formControlName="thu"> Jue
                    </label>
                    <label class="flex items-center justify-center gap-2 border rounded-md py-2 hover:bg-gray-50">
                      <input type="checkbox" formControlName="fri"> Vie
                    </label>
                    <label class="flex items-center justify-center gap-2 border rounded-md py-2 hover:bg-gray-50">
                      <input type="checkbox" formControlName="sat"> Sáb
                    </label>
                    <label class="flex items-center justify-center gap-2 border rounded-md py-2 hover:bg-gray-50">
                      <input type="checkbox" formControlName="sun"> Dom
                    </label>
                  </div>
                  <p class="mt-2 text-xs text-gray-600">
                    Solo se generarán fechas dentro del mes vigente y no en feriados.
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Botones -->
          <div class="pt-2 space-y-3">
            <button type="submit"
                    class="w-full inline-flex items-center justify-center px-4 py-3 rounded-md
                           border border-blue-600 text-blue-600 font-semibold
                           hover:bg-blue-50 focus:outline-none focus:ring-4 ring-blue-200 transition">
              Registrar
            </button>

            <a [routerLink]="perfilLink"
               class="w-full inline-flex items-center justify-center px-4 py-3 rounded-md
                      bg-blue-600 text-white font-semibold hover:bg-blue-700
                      focus:outline-none focus:ring-4 ring-blue-200 transition">
              Cancelar
            </a>
          </div>
        </form>
      </div>
    </section>
  </div>

  <!-- Estilos locales para el calendario de Angular Material (para MULTI-DÍA) -->
  <style>
    .mat-calendar-body-disabled .mat-calendar-body-cell-content { opacity: 0.35; }
    .holiday-cell .mat-calendar-body-cell-content { background: #0D1440; color: #fff; opacity: 0.35; border-radius: 9999px; }
    .available-cell .mat-calendar-body-cell-content { background: rgba(13, 20, 64, 0.06); border-radius: 9999px; }
  </style>
</app-layout>
